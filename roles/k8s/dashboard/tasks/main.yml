---
# tasks file for dashboard
- name: install dashboard
  command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/"{{dashboard_version}}"/src/deploy/recommended/kubernetes-dashboard.yaml
  environment: 
    KUBECONFIG: /home/{{hostvars['k8s'].ansible_user}}/.kube/config

- name: copy dashboard-adminuser.yaml
  copy:
    src: ./roles/k8s/dashboard/dashboard-adminuser.yaml
    dest: $HOME/

- name: create dashboard rbac
  command: kubectl apply -f $HOME/dashboard-adminuser.yaml
  environment:
    KUBECONFIG: /home/{{hostvars['k8s'].ansible_user}}/.kube/config

- name: show bearer token
  shell: kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')
  register: dashboard_token_info
  environment:
    KUBECONFIG: /home/{{hostvars['k8s'].ansible_user}}/.kube/config

- name: save bearer token to local
  local_action: copy content="{{dashboard_token_info.stdout}}" dest=./secret_token.log

